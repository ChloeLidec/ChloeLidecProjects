{% extends 'basegen.html' %}
{% block styles %}
{% load static %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" />
{% endblock %}
{% block center %}
{% if user.is_authenticated %}
<div class="d-flex justify-content-evenly m-3">
    <div class="d-flex flex-column w-25 m-3">
        <form method="POST" action="{% url 'Suivi:suivi_general' %}">
            {% csrf_token %}
            <div class="d-flex justify-content w-100">
                <h2>Filtres</h2>
                <button class="btn" id="dep_fil" type="button" onclick="plie_deplie_semaines()">
                    <svg id="flecg" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                        class="bi bi-arrow-down-circle-fill m-1" viewBox="0 0 32 32">
                        <path
                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z" />
                    </svg></button>
            </div>
            <div id="groupe_filtre" class="w-100">
                <select class="form-select" name="semaine" id="selec-sem" class="m-3 w-75">
                    {% for semaine in semaines %}
                    {% if semaine.id_semaine == semaine_select %}
                    <option value="{{ semaine.id_semaine }}" selected>Sem {{ semaine.id_semaine }}
                        {{ semaine.date_debut }}</option>

                    {% else %}
                    <option value="{{ semaine.id_semaine }}">Sem {{ semaine.id_semaine }} {{ semaine.date_debut }}
                    </option>

                    {% endif %}
                    {% endfor %}
                </select>
                <div class="d-flex justify-content w-100">
                    <h3>Groupes</h3>
                    <button class="btn" id="dep_grp" type="button" onclick="plie_deplie_filtres()">
                        <svg id="fleci" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                            class="bi bi-arrow-down-circle-fill m-1" viewBox="0 0 32 32">
                            <path
                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z" />
                        </svg></button>
                </div>
                <div id="grps_filtres" class="d-flex flex-column m-3 p-2">
                    {% for groupe in groupes %}
                    <div class="m-2">
                        {% if groupe in groupes_select %}
                        <input type="checkbox" id="{{ groupe }}" name="groupe" value="{{ groupe }}"
                            class="form-check-input" checked>
                        {% else %}
                        <input type="checkbox" id="{{ groupe }}" name="groupe" value="{{ groupe }}"
                            class="form-check-input">
                        {% endif %}
                        <label for="{{ groupe }}" class="form-check-label">{{ groupe }}</label>
                    </div>
                    {% endfor %}
                </div>
                <input class="btn btn-primary" id="liaison_bd" value="Valider" type="submit"></input>
            </div>
        </form>

    </div>
    <div class="d-flex w-75 flex-column">
        <form method="POST" action="{% url 'Suivi:suivi_general' %}">
            {% csrf_token %}
            <input type="hidden" name="semaine_act" value="{{semaine_select}}"/>
    <div class="d-flex flex-column table-responsive m-4" style="height: 75vh;">
        <table class="table table-hover align-middle" id="suivietu">
            <thead style="position: sticky;top: 0px;background-color: white;">
                <tr>
                    <th colspan="6" class="table-dark text-center align-middle">
                        Suivi Etudiant
                    </th>
                </tr>
                <tr>
                    <th class="text-center align-middle col-md-1">Etudiant</th>
                    <th class="text-center align-middle col-md-1">Total part oraux</th>
                    <th class="text-center align-middle col-md-1">Groupe</th>
                    <th class="text-center align-middle col-md-1">Moyenne generale</th>
                    <th class="text-center align-middle col-md-1">Dernier soutien</th>
                    <th class="text-center align-middle col-md-1">Dernier commentaire</th>
                </tr>
            </thead>
            <tbody style="overflow-y: scroll;">
                {% for eleve in suivi_gen %}
                <tr>
                    <th class="text-center col-md-1" scope="row">
                        {% if eleve.dern_sout %}
                        <input type="hidden" name="etu" value="{{eleve.etu.num_etu}}" />
                        {% endif %}
                        <a href="{% url 'Suivi:suivi_etudiant' eleve.etu.num_etu %}" target="_blank">
                            {{eleve.etu.nom }}
                            {{eleve.etu.prenom }}</a>
                    </th>
                    <td class="text-center col-md-1" id="eleve_total_oraux">{{ eleve.tot_part }}</td>
                    <td class="text-center col-md-1" id="eleve_groupe">{{ eleve.etu.groupe }}</td>
                    <td class="text-center col-md-1" id="eleve_moyenne">{{ eleve.moy_gen }}</td>
                    {% for jour in jours %}
                    {% if forloop.counter == eleve.dern_sout.id_soutien.id_creneau.jour %}
                    <td class="text-center col-md-1" id="eleve_dernier_soutien">
                        {{eleve.dern_sout.id_soutien.id_matiere.nom_matiere }} </br>
                        {{jour}} {{eleve.dern_sout.id_soutien.id_creneau.heure_debut}}</td>
                    {%endif%}
                    {%endfor%}
                    {% if not eleve.dern_sout %}
                    <td class="text-center col-md-1" id="eleve_dernier_soutien">--</br>
                    <td class="text-center col-md-1" id="eleve_commentaire">--</td>
                    {% else %}
                    {% if not eleve.dern_sout.commentaire %}
                    <td class="text-center col-md-1" id="eleve_commentaire"><input type="hidden" name="sout" value="{{eleve.dern_sout.id_soutien.id_soutien}}"/><textarea name="commsout" wrap="soft"
                        rows="4" value=""></textarea></td>
                    {% else %}
                    <td class="text-center col-md-1" id="eleve_commentaire"><input type="hidden" name="sout" value="{{eleve.dern_sout.id_soutien.id_soutien}}"/><textarea name="commsout" wrap="soft"
                            rows="4" value="{{eleve.dern_sout.commentaire}}">{{eleve.dern_sout.commentaire}}</textarea>
                    </td>
                    {% endif %}
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button class="btn btn-primary" type="submit" name="envoi-comm" value="envoi-comm">Envoi commentaires</button></form>
    </div>
    {% else %}
    <!-- on affiche la page de connexion /login -->
    {% include 'connexion.html' %}
    {% endif %}
    {% endblock %}
    {% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#suivietu').DataTable({
                "paging": false,
                "info": false,
                "searching": false,
                "autoWidth": false,
                "ordering": true,
            }
            );
        });
    </script>
    <script src="{% static 'js/plie_dep.js' %}"></script>
    {% endblock %}